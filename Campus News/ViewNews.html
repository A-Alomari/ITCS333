<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UniHub</title>
  <link rel="icon" href="../images/Logo.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="Style.css" rel="stylesheet" />
</head>
<body>
<!-- Header -->
<header class="p-3 navbar navbar-expand-md navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="../index.html">
            <img src="Pic\Logo.png" alt="Logo" width="30" height="24">
        </a>
        <button class="navbar-toggler ms-auto" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav mr-auto">
                <a class="nav-link" href="../index.html">Home</a>
                <a class="nav-link active" href="../Campus News/Campus News.html">Campus News</a>
                <a class="nav-link" href="../course-review2/Course-Review.html">Course Review</a>
                <a class="nav-link" href="../Events Calendar/Events-Calender.html">Events Calendar</a>
                <a class="nav-link" href="../Phase1_Course-Notes/Course-Notes.html">Course Notes</a>
                <a class="nav-link" href="../Phase1-ClubActivity/ClubActivity.html">Club Activities</a>
                <a class="nav-link" href="../student-Marketplace/StudentMarketplace.html">Student Marketplace</a>
            </div>
        </div>
    </div>
  </header>
<!--Main-->
<main class="container mt-4">
    <!-- Back, Edit, and Delete Buttons -->
    <div class="mb-3 d-flex justify-content-between">
        <a href="Campus News.html" class="btn" style="background-color: #4DA1A9; color: white;">Back</a>
        <div>
            <a href="EditArticle.html" class="btn btn-outline-secondary">Edit</a>
            <button class="btn btn-danger" id="deleteButton">Delete</button>
        </div>
    </div>
        <!-- News Article Section -->
        <section class="row">
            <!-- Article Image -->
            <div class="col-md-5">
                <img src="Pic\University-of-Bahrain-1260x630.jpg" class="img-fluid rounded article-image" alt="Article Image">
            </div>
    
            <!-- Article Title & Content -->
            <div class="col-md-7">
                <div class="article-header mb-4">
                    <h1 class="article-title">[Article Title]</h1>
                    <div class="article-meta">
                        <p class="h5 mb-1">üóìÔ∏è [Publication Date]</p>
                        <p class="h5 mb-0">‚úçÔ∏è [Author Name]</p>
                    </div>
                </div>
                <div class="article-content mt-3">
                    <p class="lead">[Insert the main content of the news article here. This section will contain the body of the article, providing detailed information about the topic being covered.]</p>
                </div>
            </div>
        </section>
    
        <!-- Comments Section -->
        <section class="mt-5">
            <h3 class="comment-header">Comments:</h3>
            <!-- Add New Comment Form -->
            <form id="addCommentForm" class="mb-4">
                <div class="mb-2">
                    <input type="text" class="form-control" id="commenterName" placeholder="Your Name" required>
                </div>
                <div class="mb-2">
                    <textarea class="form-control" id="commentText" rows="2" placeholder="Write your comment here..." required></textarea>
                </div>
                <button type="submit" class="btn btn-success">Submit Comment</button>
            </form>
            <!-- Comments List -->
            <div id="commentsList"></div>
        </section>
    </main>
    
    <!-- Feedback Modal -->
    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="feedbackModalLabel">Notification</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="feedbackModalBody"></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary btn-cancel" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-confirm btn-primary" style="border-radius: 0.375rem">Confirm</button>
            </div>
          </div>
        </div>
      </div>

    <footer class="text-center py-3 mt-5">
        &copy; 2025 UNIHUB. All rights reserved.
    </footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="CampusNews.js"></script>
// Replace the existing script section with this corrected version
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Retrieve the selected article ID from localStorage
        const articleId = localStorage.getItem('selectedArticleId');

        if (!articleId) {
            document.querySelector('main').innerHTML = '<p class="text-danger">No article selected.</p>';
            return;
        }

        // Fetch the article data
        fetch('./news.json?' + new Date().getTime())
            .then(response => response.json())
            .then(articles => {
                const article = articles.find(a => a.id == articleId);
                if (!article) throw new Error('Article not found');
                
                // Populate article details
                document.querySelector('.article-title').textContent = article.title;
                document.querySelector('.article-image').src = article.image;
                document.querySelector('.article-meta .h5:nth-child(1)').textContent = `üóìÔ∏è ${article.date}`;
                document.querySelector('.article-meta .h5:nth-child(2)').textContent = `‚úçÔ∏è ${article.author}`;
                document.querySelector('.article-content .lead').innerHTML = article.content;
            })
            .catch(error => {
                console.error('Error:', error);
                document.querySelector('main').innerHTML = `<p class="text-danger">${error.message}</p>`;
            });

        // Delete button handler
        const deleteButton = document.getElementById('deleteButton');
        if (deleteButton) {
            deleteButton.addEventListener('click', () => {
                showDeleteConfirmation(articleId);
            });
        }

        // On article load, also load comments
        if (articleId) loadComments(articleId);
    });

    function showDeleteConfirmation(articleId) {
        const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
        const modalBody = document.getElementById('feedbackModalBody');
        const confirmBtn = document.querySelector('.btn-confirm');
        const cancelBtn = document.querySelector('.btn-cancel');

        // Show confirmation dialog
        modalBody.textContent = 'Are you sure you want to delete this article?';
        confirmBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
        confirmBtn.textContent = 'Delete';
        confirmBtn.classList.remove('btn-primary');
        confirmBtn.classList.add('btn-danger');
        
        // Clear previous event listeners
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        document.querySelector('.btn-confirm').onclick = async () => {
            document.querySelector('.btn-confirm').disabled = true;
            try {
                const formData = new FormData();
                formData.append('id', articleId);
                
                const response = await fetch('deleteArticle.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
    modal.hide();
    // Redirect to Campus News page after successful deletion
    window.location.href = 'Campus News.html?' + new Date().getTime();
} else {
    throw new Error(result.message || 'Failed to delete article');
}
            } catch (error) {
                showFeedbackMessage(`Error: ${error.message}`);
                document.querySelector('.btn-confirm').disabled = false;
            }
        };
        
        modal.show();
    }

    function showFeedbackMessage(message) {
        const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
        const modalBody = document.getElementById('feedbackModalBody');
        const confirmBtn = document.querySelector('.btn-confirm');
        const cancelBtn = document.querySelector('.btn-cancel');

        modalBody.textContent = message;
        confirmBtn.style.display = 'none';
        cancelBtn.style.display = 'inline-block';
        cancelBtn.textContent = 'OK';
        
        // Clear previous event listeners
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        document.querySelector('.btn-cancel').onclick = () => {
            modal.hide();
        };
        
        modal.show();
    }

    async function loadComments(articleId) {
        const commentsList = document.getElementById('commentsList');
        commentsList.innerHTML = '<div>Loading comments...</div>';
        try {
            const response = await fetch('comments.json?' + new Date().getTime());
            const comments = await response.json();
            const articleComments = comments.filter(c => c.articleId == articleId);
            if (articleComments.length === 0) {
                commentsList.innerHTML = '<div class="text-muted">No comments yet.</div>';
                return;
            }
            commentsList.innerHTML = '';
            articleComments.forEach(comment => {
                const commentBox = document.createElement('div');
                commentBox.className = 'comment-box mb-3 p-3 border rounded';
                commentBox.innerHTML = `
                    <h5>${comment.author}</h5>
                    <p class="comment-content" data-id="${comment.id}">${comment.content}</p>
                    <small class="text-muted">${comment.date}</small><br>
                    <button class="btn btn-outline-secondary btn-sm edit-comment mt-2" data-id="${comment.id}">Edit</button>
                    <button class="btn btn-outline-danger btn-sm delete-comment mt-2" data-id="${comment.id}">Delete</button>
                `;
                commentsList.appendChild(commentBox);
            });
        } catch (error) {
            commentsList.innerHTML = '<div class="text-danger">Failed to load comments.</div>';
        }
    }

    // Add Comment
    const addCommentForm = document.getElementById('addCommentForm');
    if (addCommentForm) {
        addCommentForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const articleId = localStorage.getItem('selectedArticleId');
            const author = document.getElementById('commenterName').value.trim();
            const content = document.getElementById('commentText').value.trim();
            if (!author || !content) return;
            
            const formData = new FormData();
            formData.append('articleId', articleId);
            formData.append('author', author);
            formData.append('content', content);
            
            try {
                const response = await fetch('addComment.php', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    window.location.reload(); // Refresh the page after adding
                } else {
                    showFeedbackMessage('Error: ' + (result.message || 'Failed to add comment'));
                }
            } catch (error) {
                showFeedbackMessage('An error occurred while adding the comment');
            }
        });
    }

    // Edit/Delete Comment Handlers
    document.getElementById('commentsList').addEventListener('click', function(e) {
        const articleId = localStorage.getItem('selectedArticleId');
        
        if (e.target.classList.contains('delete-comment')) {
            const commentId = e.target.getAttribute('data-id');
            showDeleteCommentConfirmation(commentId);
        } else if (e.target.classList.contains('edit-comment')) {
            const commentId = e.target.getAttribute('data-id');
            const contentP = document.querySelector(`.comment-content[data-id="${commentId}"]`);
            const oldContent = contentP.textContent;
            showEditCommentModal(commentId, oldContent);
        }
    });

    function showDeleteCommentConfirmation(commentId) {
        const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
        const modalBody = document.getElementById('feedbackModalBody');
        const confirmBtn = document.querySelector('.btn-confirm');
        const cancelBtn = document.querySelector('.btn-cancel');

        // Show confirmation dialog
        modalBody.textContent = 'Are you sure you want to delete this comment?';
        confirmBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
        confirmBtn.textContent = 'Delete';
        confirmBtn.classList.remove('btn-primary');
        confirmBtn.classList.add('btn-danger');
        
        // Clear previous event listeners
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        document.querySelector('.btn-confirm').onclick = async () => {
            document.querySelector('.btn-confirm').disabled = true;
            try {
                const formData = new FormData();
                formData.append('id', commentId);
                
                const response = await fetch('deleteComment.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    modal.hide();
                    window.location.reload(); // Refresh the page after deletion
                } else {
                    throw new Error(result.message || 'Failed to delete comment');
                }
            } catch (error) {
                showFeedbackMessage(`Error: ${error.message}`);
                document.querySelector('.btn-confirm').disabled = false;
            }
        };
        
        modal.show();
    }

    function showEditCommentModal(commentId, oldContent) {
        const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
        const modalBody = document.getElementById('feedbackModalBody');
        const confirmBtn = document.querySelector('.btn-confirm');
        const cancelBtn = document.querySelector('.btn-cancel');

        // Show edit dialog
        modalBody.innerHTML = `
            <div class="mb-3">
                <label for="editCommentText" class="form-label">Edit your comment:</label>
                <textarea class="form-control" id="editCommentText" rows="3">${oldContent}</textarea>
            </div>
        `;
        confirmBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
        confirmBtn.textContent = 'Update';
        confirmBtn.classList.remove('btn-danger');
        confirmBtn.classList.add('btn-primary');
        
        // Clear previous event listeners
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        document.querySelector('.btn-confirm').onclick = async () => {
            const newContent = document.getElementById('editCommentText').value.trim();
            if (!newContent) {
                showFeedbackMessage('Comment cannot be empty');
                return;
            }
            
            document.querySelector('.btn-confirm').disabled = true;
            try {
                const formData = new FormData();
                formData.append('id', commentId);
                formData.append('content', newContent);
                
                const response = await fetch('editComment.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    modal.hide();
                    window.location.reload(); // Refresh the page after editing
                } else {
                    throw new Error(result.message || 'Failed to update comment');
                }
            } catch (error) {
                showFeedbackMessage(`Error: ${error.message}`);
                document.querySelector('.btn-confirm').disabled = false;
            }
        };
        
        modal.show();
    }
</script>

<!-- Edit Comment Modal -->
<div class="modal fade" id="customModal" tabindex="-1" aria-labelledby="customModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customModalLabel">Edit Comment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="customModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modalCloseBtn">Close</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>